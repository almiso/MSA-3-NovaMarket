events {
    worker_connections 1024;
}

http {
    # 1. Задаем лимиты в зависимости от типа клиента (заголовок Client-Type)
    # Используем map для создания переменных, по которым NGINX будет ограничивать запросы
    map $http_client_type $limit_web {
        default ""; # Если нет заголовка, не лимитируем по веб-зоне
        ~*web   $binary_remote_addr;
    }

    map $http_client_type $limit_mobile {
        ~*mobile $binary_remote_addr;
    }

    # 2. Объявляем зоны лимитирования
    # Веб-приложение — до 50 запросов в секунду с одного IP.
    limit_req_zone $limit_web zone=web_zone:10m rate=50r/s;

    # Мобильное приложение — до 30 запросов в секунду с одного IP.
    limit_req_zone $limit_mobile zone=mobile_zone:10m rate=30r/s;

    # Имитация бэкенда приложения
    upstream backend {
        server localhost:8881;
    }

    server {
        listen 8080;

        location /api/ {
            # Применяем обе зоны. NGINX будет применять ту, переменная которой не пустая.
            # Если запрос содержит Client-Type: web, $limit_mobile пустой и это правило игнорируется,
            # но срабатывает limit_req для web_zone.
            limit_req zone=web_zone burst=100;
            limit_req zone=mobile_zone burst=60;
            
            # Возвращаем кастомный ответ 503 при превышении (опционально, NGINX и так отдаст 503)
            limit_req_status 503;

            proxy_pass http://backend;
        }
    }

    # Тестовый сервер для имитации бэкенда приложения (из задания)
    server {
        listen 8881;
        
        location /api/ {
            add_header Content-Type application/json;
            
            # Эмулируем разное поведение в зависимости от заголовка
            if ($http_client_type = "web") {
                return 200 '{"status": "success", "service": "web_backend", "data": "Web application response"}';
            }
            if ($http_client_type = "mobile") {
                return 200 '{"status": "success", "service": "mobile_backend", "data": "Mobile application response"}';
            }
            
            # Дефолтный ответ
            return 200 '{"status": "success", "service": "default_backend", "data": "Default response"}';
        }
    }
}
