events {
    worker_connections 1024;
}

http {
    # 1. Настраиваем Circuit Breaker для логистики
    # max_fails=5: если 5 запросов подряд завершаются ошибкой (или таймаутом)
    # fail_timeout=30s: выключаем этот сервер из балансировки на 30 секунд
    upstream logistics_backend {
        server localhost:9999 max_fails=5 fail_timeout=30s;
    }

    server {
        listen 8080;

        location /logistics/ {
            proxy_pass http://logistics_backend/;
            
            # 2. Таймаут ответа — три секунды (исправляем с 30s)
            proxy_connect_timeout 3s;
            proxy_read_timeout 3s;
            
            # Если backend недоступен, отваливается по таймауту или circuit breaker открыт (502/504),
            # обрабатываем ошибку отдавая fallback-ответ, чтобы не светить стандартную страницу NGINX
            proxy_intercept_errors on;
            error_page 502 503 504 = @fallback;
        }

        # Контролируемый ответ (fallback) на время недоступности сервиса
        location @fallback {
            default_type application/json;
            return 503 '{"status": "error", "service": "logistics", "message": "Logistics service is temporarily unavailable. Please try again later."}';
        }
    }

    # Тестовый сервер для имитации логистического сервиса (из задания)
    server {
        listen 9999;
        
        location / {
            add_header Content-Type application/json;
            
            # Нормальный быстрый ответ
            if ($arg_type = "fast") {
                return 200 '{"status": "success", "service": "logistics", "response_time": "fast", "tracking_id": "TRK_FAST_123"}';
            }
            
            # Медленный ответ (превышает таймаут в 3 сек)
            if ($arg_type = "slow") {
                return 200 '{"status": "slow", "service": "logistics", "response_time": "5000ms", "message": "This response is delayed"}';
            }
            
            # Ответ с ошибкой
            if ($arg_type = "error") {
                return 500 '{"status": "error", "service": "logistics", "error_code": "INTERNAL_ERROR", "message": "Service temporarily unavailable"}';
            }
            
            # Случайное поведение для тестирования
            if ($arg_type = "random") {
                return 200 '{"status": "success", "service": "logistics", "type": "random", "note": "Random behavior simulation"}';
            }
            
            # Стандартный успешный ответ
            return 200 '{"status": "success", "service": "logistics", "data": {"tracking_id": "TRK123456", "estimated_delivery": "2024-01-15", "status": "in_transit"}}';
        }
        
        # Специальные endpoints для тестирования Circuit Breaker
        location /fast {
            add_header Content-Type application/json;
            return 200 '{"status": "success", "endpoint": "fast", "message": "Quick response"}';
        }
        
        location /slow {
            add_header Content-Type application/json;
            # Этот endpoint всегда медленный (5 секунд)
            return 200 '{"status": "slow", "endpoint": "slow", "message": "This is a deliberately slow response", "delay": "5000ms"}';
        }
        
        location /error {
            add_header Content-Type application/json;
            return 503 '{"status": "error", "endpoint": "error", "error": "service_unavailable", "message": "Logistics service is experiencing issues"}';
        }
    }
}
