# Реестр событий Saga-хореографии оформления заказа

Архитектурный паттерн: **Event-Driven Architecture (Saga Choreography)** на базе Apache Kafka (без использования оркестратора).

| Этап                                                  | Тип события  | Название (Событие)           |
|:------------------------------------------------------|:-------------|:-----------------------------|
| Создание заказа покупателем (начало сборки)           | domain       | `OrderCreated`               |
| Успешное резервирование товаров на складе             | domain       | `InventoryReserved`          |
| Сумма корзины не совпала или товара нет на складе     | failure      | `InventoryReservationFailed` |
| Успешная оплата заказа                                | domain       | `PaymentSucceeded`           |
| Ошибка оплаты (недостаточно средств / ошибка банка)   | failure      | `PaymentFailed`              |
| Отмена заказа (компенсация в стейт-машине)            | compensation | `OrderCancelled`             |
| Отмена резерва на складе (возврат товара на полку)    | compensation | `InventoryReleased`          |
| Возврат денег (если отмена произошла после оплаты)    | compensation | `RefundSucceeded`            |
| Успешное формирование заявки на доставку              | domain       | `DeliveryScheduled`          |
| Доставка неуспешна / Ошибка логистического провайдера | failure      | `DeliveryFailed`             |

---

### Описание процесса:
1. Инициатором Саги выступает **OMS (Order Management System)** путем публикации доменного события `OrderCreated`. До этого момента пользователь собирает товары через **Cart Service**, который предварительно проверяет наличие в **Inventory Service**.
2. Последующие микросервисы (**Inventory Service**, **Payment Service**, **Logistics Service**) реагируют на целевые для них события через Message Broker.
3. В случае сбоя (вызов события из категории `failure`), генерируется цепочка компенсирующих событий (категория `compensation`), откатывающих систему к консистентному состоянию (возврат средств, снятие резервов).
4. Сервис **OrderHistory** подписывается на терминальные события (например, `DeliveryScheduled` или `OrderCancelled`) для сохранения финального слепка заказа в архив для истории на чтение заказчиком.
